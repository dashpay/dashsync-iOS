//
//  DSPaymentProtocolTests.m
//  DashSync_Tests
//
//  Created by Andrew Podkovyrin on 20/06/2018.
//  Copyright Â© 2018 Dash Core Group. All rights reserved.
//

#import <XCTest/XCTest.h>

#import "DSChain.h"
#import "DSPaymentProtocol.h"
#import "NSString+Bitcoin.h"

@interface DSPaymentProtocolTests : XCTestCase

@property (strong, nonatomic) DSChain *chain;

@end

@implementation DSPaymentProtocolTests

- (void)setUp {
    [super setUp];
    // Put setup code here. This method is called before the invocation of each test method in the class.

    // the chain to test on
    self.chain = [DSChain mainnet];
}

- (void)testPaymentProtocol {
    NSData *d =
        @"0801120b783530392b7368613235361ab81d0ac90b308205c5308204ada00302010202072b858c53eeed2f300d06092a864886f70d010"
         "10505003081ca310b30090603550406130255533110300e060355040813074172697a6f6e61311330110603550407130a53636f7474736"
         "4616c65311a3018060355040a1311476f44616464792e636f6d2c20496e632e31333031060355040b132a687474703a2f2f63657274696"
         "66963617465732e676f64616464792e636f6d2f7265706f7369746f72793130302e06035504031327476f2044616464792053656375726"
         "52043657274696669636174696f6e20417574686f726974793111300f060355040513083037393639323837301e170d313330343235313"
         "9313130305a170d3135303432353139313130305a3081be31133011060b2b0601040182373c0201031302555331193017060b2b0601040"
         "182373c020102130844656c6177617265311d301b060355040f131450726976617465204f7267616e697a6174696f6e3110300e0603550"
         "405130735313633393636310b30090603550406130255533110300e0603550408130747656f726769613110300e0603550407130741746"
         "c616e746131153013060355040a130c4269745061792c20496e632e311330110603550403130a6269747061792e636f6d30820122300d0"
         "6092a864886f70d01010105000382010f003082010a0282010100c46eefc28b157d03717f0c00a1d67ba7612c1f2b562182ce99602c476"
         "8ff8fbd106685d939263266bb9e107d057db844502d8ec61e887ea55b55c2c17121896454a319f65b3db34c8629a75b3e123fe2076d85c"
         "f4f644ae3f6fb8429c5a7830df465859c4d6c0bcdbc12865fab2218bd65f2b2530012ce499698ccae0259ac0b3470a8566b705e1a661ad"
         "8286429acf0b3136e4cdf4d9119084a5b6ecf197694c2b55782701211ca28dafa6d96acecc2232ac5e9a86181d4f7417fd8d938507f6d0"
         "c6252940216300946f7627013d74998e0922d4b9c97a7779b1d56f30c07d0269b1589bd604d384a5237213c75d0c6bf811bce8cdbbb06c"
         "1a2c6e479d271fd0203010001a38201b8308201b4300f0603551d130101ff04053003010100301d0603551d250416301406082b0601050"
         "507030106082b06010505070302300e0603551d0f0101ff0404030205a030330603551d1f042c302a3028a026a0248622687474703a2f2"
         "f63726c2e676f64616464792e636f6d2f676473332d37322e63726c30530603551d20044c304a3048060b6086480186fd6d01071703303"
         "9303706082b06010505070201162b687474703a2f2f6365727469666963617465732e676f64616464792e636f6d2f7265706f7369746f7"
         "2792f30818006082b0601050507010104743072302406082b060105050730018618687474703a2f2f6f6373702e676f64616464792e636"
         "f6d2f304a06082b06010505073002863e687474703a2f2f6365727469666963617465732e676f64616464792e636f6d2f7265706f73697"
         "46f72792f67645f696e7465726d6564696174652e637274301f0603551d23041830168014fdac6132936c45d6e2ee855f9abae7769968c"
         "ce730250603551d11041e301c820a6269747061792e636f6d820e7777772e6269747061792e636f6d301d0603551d0e04160414b941175"
         "67ae7c3ef507282acc4d551c6bf7fa44a300d06092a864886f70d01010505000382010100b8d5aca963a6f9a0b5c5af034acc832a13f1b"
         "beb932d397a7d4bd3a45e6a3d6db3109a2354a80814ee3e6c7ceff5d7f4a983dbde55f096ba992d0fff4fe1a92eaab79bd147b3521ee36"
         "12cee2cf7595bc635a1feefc6db5c583a5923c71c864ddacbcff463e9967f4c02bdd77271635575967ec23e8b6cdbdab632ce79072f477"
         "04a6ef1f160310837de456e4a01a22bbf89d8e0f5267dfb71998ade3ea260dc9bc6cff3899a88caf6a5e0ea7497ffbc42ed4fa69551e5e"
         "0b2156e9e2d225ba7a5e56de5ff130a4c6e5f1a9968687b82620f861702d56c4429799fff9db2562bc2dce97fe7e34a1fabb039e5e78bd"
         "4dae60f5868a5e8a3f8c330e37f38fbfe1f0ae209308204de308203c6a00302010202020301300d06092a864886f70d010105050030633"
         "10b30090603550406130255533121301f060355040a131854686520476f2044616464792047726f75702c20496e632e3131302f0603550"
         "40b1328476f20446164647920436c61737320322043657274696669636174696f6e20417574686f72697479301e170d303631313136303"
         "1353433375a170d3236313131363031353433375a3081ca310b30090603550406130255533110300e060355040813074172697a6f6e613"
         "11330110603550407130a53636f74747364616c65311a3018060355040a1311476f44616464792e636f6d2c20496e632e3133303106035"
         "5040b132a687474703a2f2f6365727469666963617465732e676f64616464792e636f6d2f7265706f7369746f72793130302e060355040"
         "31327476f204461646479205365637572652043657274696669636174696f6e20417574686f726974793111300f0603550405130830373"
         "9363932383730820122300d06092a864886f70d01010105000382010f003082010a0282010100c42dd5158c9c264cec3235eb5fb859015"
         "aa66181593b7063abe3dc3dc72ab8c933d379e43aed3c3023848eb33014b6b287c33d9554049edf99dd0b251e21de65297e35a8a954ebf"
         "6f73239d4265595adeffbfe5886d79ef4008d8c2a0cbd4204cea73f04f6ee80f2aaef52a16966dabe1aad5dda2c66ea1a6bbbe51a514a0"
         "02f48c79875d8b929c8eef8666d0a9cb3f3fc787ca2f8a3f2b5c3f3b97a91c1a7e6252e9ca8ed12656e6af6124453703095c39c2b582b3"
         "d08744af2be51b0bf87d04c27586bb535c59daf1731f80b8feead813605890898cf3aaf2587c049eaa7fd67f7458e97cc1439e23685b57"
         "e1a37fd16f671119a743016fe1394a33f840d4f0203010001a38201323082012e301d0603551d0e04160414fdac6132936c45d6e2ee855"
         "f9abae7769968cce7301f0603551d23041830168014d2c4b0d291d44c1171b361cb3da1fedda86ad4e330120603551d130101ff0408300"
         "60101ff020100303306082b0601050507010104273025302306082b060105050730018617687474703a2f2f6f6373702e676f646164647"
         "92e636f6d30460603551d1f043f303d303ba039a0378635687474703a2f2f6365727469666963617465732e676f64616464792e636f6d2"
         "f7265706f7369746f72792f6764726f6f742e63726c304b0603551d200444304230400604551d20003038303606082b060105050702011"
         "62a687474703a2f2f6365727469666963617465732e676f64616464792e636f6d2f7265706f7369746f7279300e0603551d0f0101ff040"
         "403020106300d06092a864886f70d01010505000382010100d286c0ecbdf9a1b667ee660ba2063a04508e1572ac4a749553cb37cb4449e"
         "f07906b33d996f09456a51330053c8532217bc9c70aa824a490de46d32523140367c210d66f0f5d7b7acc9fc5582ac1c49e21a85af3aca"
         "446f39ee463cb2f90a4292901d9722c29df370127bc4fee68d3218fc0b3e4f509edd210aa53b4bef0cc590bd63b961c952449dfceecfda"
         "7489114450e3a366fda45b345a241c9d4d7444e3eb97476d5a213552cc687a3b599ac0684877f7506fcbf144c0ecc6ec4df3db71271f4e"
         "8f15140222849e01d4b87a834cc06a2dd125ad186366403356f6f776eebf28550985eab0353ad9123631f169ccdb9b205633ae1f4681b1"
         "705359553ee0a840830820400308202e8a003020102020100300d06092a864886f70d01010505003063310b30090603550406130255533"
         "121301f060355040a131854686520476f2044616464792047726f75702c20496e632e3131302f060355040b1328476f204461646479204"
         "36c61737320322043657274696669636174696f6e20417574686f72697479301e170d3034303632393137303632305a170d33343036323"
         "93137303632305a3063310b30090603550406130255533121301f060355040a131854686520476f2044616464792047726f75702c20496"
         "e632e3131302f060355040b1328476f20446164647920436c61737320322043657274696669636174696f6e20417574686f72697479308"
         "20120300d06092a864886f70d01010105000382010d00308201080282010100de9dd7ea571849a15bebd75f4886eabeddffe4ef671cf46"
         "568b35771a05e77bbed9b49e970803d561863086fdaf2ccd03f7f0254225410d8b281d4c0753d4b7fc777c33e78ab1a03b5206b2f6a2bb"
         "1c5887ec4bb1eb0c1d845276faa3758f78726d7d82df6a917b71f72364ea6173f659892db2a6e5da2fe88e00bde7fe58d15e1ebcb3ad5e"
         "212a2132dd88eaf5f123da0080508b65ca565380445991ea3606074c541a572621b62c51f6f5f1a42be025165a8ae23186afc7803a94d7"
         "f80c3faab5afca140a4ca1916feb2c8ef5e730dee77bd9af67998bcb10767a2150ddda058c6447b0a3e62285fba41075358cf117e3874c"
         "5f8ffb569908f8474ea971baf020103a381c03081bd301d0603551d0e04160414d2c4b0d291d44c1171b361cb3da1fedda86ad4e330818"
         "d0603551d230481853081828014d2c4b0d291d44c1171b361cb3da1fedda86ad4e3a167a4653063310b300906035504061302555331213"
         "01f060355040a131854686520476f2044616464792047726f75702c20496e632e3131302f060355040b1328476f20446164647920436c6"
         "1737320322043657274696669636174696f6e20417574686f72697479820100300c0603551d13040530030101ff300d06092a864886f70"
         "d01010505000382010100324bf3b2ca3e91fc12c6a1078c8e77a03306145c901e18f708a63d0a19f98780116e69e4961730ff349163723"
         "8eecc1c01a31d9428a431f67ac454d7f6e5315803a2ccce62db944573b5bf45c924b5d58202ad2379698db8b64dcecf4cca3323e81c88a"
         "a9d8b416e16c920e5899ecd3bda70f77e992620145425ab6e7385e69b219d0a6c820ea8f8c20cfa101e6c96ef870dc40f618badee832b9"
         "5f88e92847239eb20ea83ed83cd976e08bceb4e26b6732be4d3f64cfe2671e26111744aff571a870f75482ecf516917a002126195d5d14"
         "0b2104ceec4ac1043a6a59e0ad595629a0dcf8882c5320ce42b9f45e60d9f289cb1b92a5a57ad370faf1d7fdbbd9f229b010a046d61696"
         "e121f08e0b60d121976a914a533d4fa076634afef47451f6aec8cdc1e49daf088ac18eee1809b0520f2e8809b052a395061796d656e742"
         "07265717565737420666f722042697450617920696e766f696365203863583552624e38616f666335336157416d35584644322b6874747"
         "0733a2f2f6269747061792e636f6d2f692f3863583552624e38616f666335336157416d355846442a80025ef88bec4e09be979b0706647"
         "64afae4fa3b1eca954744a76699b18530183e6f467ec5923913668c5abe382cb7ef6a8858fae6180c478e81179d3935cd5323f0c5cc2ee"
         "a0f1e29b5a6b2654b4cbda389eaee32215c8777afbbe07d60a4f9fa07ab6e9a6d3ad2a9efb525221631c8044ec759d9c1fccc39bb3ee4f"
         "44ebc7c1cc8248341442722ac880da0c7d59d696706c7bcf09101b4925a0784220a93c5b309dad8e32661f2ccab4ec868b2de000f242db"
         "73fffb26937cf83ed6d2efaa771d2d2c697844b83948c98252b5f352edd4fe96b29cbe0c9ca3d107a3eb790dab5ddd73de6c748f2047db"
         "425c80c39135473cacad3619baaf28e391da4a6c7b82b74".hexToData;

    DSPaymentProtocolRequest *req = [DSPaymentProtocolRequest requestWithData:d onChain:self.chain];

    XCTAssertEqualObjects(req.data, d, @"[DSPaymentProtocolRequest toData]");

    // test that the x509 certs are valid, but the payment request is expired
    XCTAssertFalse([req isValid], @"[DSPaymentProtocolRequest isValid]");
    XCTAssertEqualObjects(req.errorMessage,
        @"Untrusted certificate - One or more certificates have expired or are not valid yet.",
        @"[DSPaymentProtocolRequest isValid]");

    NSLog(@"commonName:%@", req.commonName);
    XCTAssertEqualObjects(req.commonName, @"bitpay.com", @"[DSPaymentProtocolRequest commonName]");

    d = @"0a00125f5472616e73616374696f6e207265636569766564206279204269745061792e20496e766f6963652077696c6c206265206d617"
         "26b6564206173207061696420696620746865207472616e73616374696f6e20697320636f6e6669726d65642e".hexToData;

    DSPaymentProtocolACK *ack = [DSPaymentProtocolACK ackWithData:d onChain:self.chain];

    XCTAssertEqualObjects(ack.data, d, @"[DSPaymentProtocolACK toData]");

    NSLog(@"ack.memo = '%@'", ack.memo);
    XCTAssertNotNil(ack.memo, @"[DSPaymentProtocolACK memo]");

    d = @"120b783530392b7368613235361abe150afe0b308205fa308204e2a0030201020210090b35ca5c5bf1b98b3d8f9f4a7755d6300d06092"
         "a864886f70d01010b05003075310b300906035504061302555331153013060355040a130c446967694365727420496e633119301706035"
         "5040b13107777772e64696769636572742e636f6d313430320603550403132b4469676943657274205348413220457874656e646564205"
         "6616c69646174696f6e20536572766572204341301e170d3134303530393030303030305a170d3136303531333132303030305a3082010"
         "5311d301b060355040f0c1450726976617465204f7267616e697a6174696f6e31133011060b2b0601040182373c0201031302555331193"
         "017060b2b0601040182373c020102130844656c61776172653110300e0603550405130735313534333137310f300d06035504090c06233"
         "233303038311730150603550409130e353438204d61726b65742053742e310e300c060355041113053934313034310b300906035504061"
         "3025553311330110603550408130a43616c69666f726e6961311630140603550407130d53616e204672616e636973636f3117301506035"
         "5040a130e436f696e626173652c20496e632e311530130603550403130c636f696e626173652e636f6d30820122300d06092a864886f70"
         "d01010105000382010f003082010a0282010100b45e3ff380667aa14d5a12fc2fc983fc6618b55499933c3bde15c01d838846b4caf9848"
         "e7c40e5fa7c67ef9b5b1efe26ee5571c5fa2eff759052454701ad8931557d697b139e5d19abb3e439675f31db7f2ef1a5d97db07c1f696"
         "6266380eb4fcfa8e1471a6ecc2fbebf3e67b3eaa84d0fbe063e60380dcdb7a20203d29a94059ef7f20d472cc25783ab2a1db6a394ecc07"
         "b4024974100bcfd470f59ef3b572365213209609fad229994b4923c1df3a18c41e3e7bc1f192ba6e7e5c32ae155107e21903eff7bce9fc"
         "594b49d9f6ae7901fa191fcbae8a2cf09c3bfc24377d717b6010080c5681a7dbc6e1d52987b7ebbe95e7af4202da436e67a88472aacedc"
         "90203010001a38201f2308201ee301f0603551d230418301680143dd350a5d6a0adeef34a600a65d321d4f8f8d60f301d0603551d0e041"
         "604146d33b9743a61b7499423d1a89d085d0148680bba30290603551d1104223020820c636f696e626173652e636f6d82107777772e636"
         "f696e626173652e636f6d300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b060105050"
         "7030230750603551d1f046e306c3034a032a030862e687474703a2f2f63726c332e64696769636572742e636f6d2f736861322d65762d7"
         "365727665722d67312e63726c3034a032a030862e687474703a2f2f63726c342e64696769636572742e636f6d2f736861322d65762d736"
         "5727665722d67312e63726c30420603551d20043b3039303706096086480186fd6c0201302a302806082b06010505070201161c6874747"
         "0733a2f2f7777772e64696769636572742e636f6d2f43505330818806082b06010505070101047c307a302406082b06010505073001861"
         "8687474703a2f2f6f6373702e64696769636572742e636f6d305206082b060105050730028646687474703a2f2f636163657274732e646"
         "96769636572742e636f6d2f446967694365727453484132457874656e64656456616c69646174696f6e53657276657243412e637274300"
         "c0603551d130101ff04023000300d06092a864886f70d01010b05000382010100aadfcf94050ed938e3114a640af3d9b04276da00f5215"
         "d7148f9f16d4cac0c77bd5349ec2f47299d03c900f70146752da72829290ac50a77992f01537ab2689392ce0bfeb7efa49f4c4fe4e1e43"
         "ca1fcfb1626ce554da4f6e7fa34a597e401f215c43afd0ba777ad587eb0afacd71f7a6af7752814f7ab4c202ed76d33defd1289d541803"
         "fed01ac80a3cacfdaae29279e5de14d460475f4baf27eab693379d39120e7477bf3ec719664c7b6cb5e557556e5bbddd9c9d1ebc9f835e"
         "9da5b3dbb72fe8d94ac05eab3c479987520ade3a1d275e1e2fe725698d2f7cb1390a9d40ea6cbf21a73bddccd1ad61aa249ce8e2885a37"
         "30b7d53bd075f55099d2960f3cc0aba09308204b63082039ea00302010202100c79a944b08c11952092615fe26b1d83300d06092a86488"
         "6f70d01010b0500306c310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b1"
         "3107777772e64696769636572742e636f6d312b30290603550403132244696769436572742048696768204173737572616e63652045562"
         "0526f6f74204341301e170d3133313032323132303030305a170d3238313032323132303030305a3075310b30090603550406130255533"
         "1153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d31343032060"
         "3550403132b4469676943657274205348413220457874656e6465642056616c69646174696f6e2053657276657220434130820122300d0"
         "6092a864886f70d01010105000382010f003082010a0282010100d753a40451f899a616484b6727aa9349d039ed0cb0b00087f16728868"
         "58c8e63dabcb14038e2d3f5eca50518b83d3ec5991732ec188cfaf10ca6642185cb071034b052882b1f689bd2b18f12b0b3d2e7881f1fe"
         "f387754535f80793f2e1aaaa81e4b2b0dabb763b935b77d14bc594bdf514ad2a1e20ce29082876aaeead764d69855e8fdaf1a506c54bc1"
         "1f2fd4af29dbb7f0ef4d5be8e16891255d8c07134eef6dc2decc48725868dd821e4b04d0c89dc392617ddf6d79485d80421709d6f6fff5"
         "cba19e145cb5657287e1c0d4157aab7b827bbb1e4fa2aef2123751aad2d9b86358c9c77b573add8942de4f30c9deec14e627e17c0719e2"
         "cdef1f9102819330203010001a38201493082014530120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020"
         "186301d0603551d250416301406082b0601050507030106082b06010505070302303406082b0601050507010104283026302406082b060"
         "105050730018618687474703a2f2f6f6373702e64696769636572742e636f6d304b0603551d1f044430423040a03ea03c863a687474703"
         "a2f2f63726c342e64696769636572742e636f6d2f4469676943657274486967684173737572616e63654556526f6f7443412e63726c303"
         "d0603551d200436303430320604551d2000302a302806082b06010505070201161c68747470733a2f2f7777772e64696769636572742e6"
         "36f6d2f435053301d0603551d0e041604143dd350a5d6a0adeef34a600a65d321d4f8f8d60f301f0603551d23041830168014b13ec3690"
         "3f8bf4701d498261a0802ef63642bc3300d06092a864886f70d01010b050003820101009db6d09086e18602edc5a0f0341c74c18d76cc8"
         "60aa8f04a8a42d63fc8a94dad7c08ade6b650b8a21a4d8807b12921dce7dac63c21e0e3114970ac7a1d01a4ca113a57ab7d572a4074fdd"
         "31d851850df574775a17d55202e473750728c7f821bd2628f2d035adac3c8a1ce2c52a20063eb73ba71c84927239764859e380ead63683"
         "cba52815879a32c0cdfde6deb31f2baa07c6cf12cd4e1bd77843703ce32b5c89a811a4a924e3b469a85fe83a2f99e8ca3cc0d5eb33dcf0"
         "4788f14147b329cc700a65cc4b5a1558d5a5668a42270aa3c8171d99da8453bf4e5f6a251ddc77b62e86f0c74ebb8daf8bf870d7950919"
         "09b183b915927f1352813ab267ed5f77a22b401121f0898b768121976a9147d5325a854f0c9a1cbb6cbfb89b2a96d837ed7bf88ac18acb"
         "9e09e0520d2bce09e052a315061796d656e74207265717565737420666f7220436f696e62617365206f7264657220636f64653a2051434"
         "f4947445041323068747470733a2f2f636f696e626173652e636f6d2f72702f35336438316266613564366231646461376230303030303"
         "43a2033363264323931393231373632313339323538373663653263623430303431622a80024d81ca72213813b2585d98005b238e268a0"
         "09ec02d04dd7a8a984832b990d740a96909d62a5df9f8f85b67329379bba0a9ba03bca3d61400d4e477984b7edcf3042261718423736c4"
         "41d140ee89d64609667de50eadb4cabbef478d3a9cbd4dfdab9a0c2818390d20c243ad02cc27abf0bbb2bab3227baa8e5d673f84991412"
         "253be1e69dfa780dc06b6f48edfa15de6d0ccec22d9faaf67b535e8b2778cdf6184da2f2d1792d34c6440988327329e9c5ae18c34dda16"
         "dcdfbf419f7fd27bf575b6f9c95b1f090021640af5c02ad027b5d76053a5840bc4d6104dd87efc31bcc3a8aefc3100235be61c03a50556"
         "6777185dd6f932baeb5d5e2d4398d01140d48".hexToData;
    req = [DSPaymentProtocolRequest requestWithData:d onChain:self.chain];

    XCTAssertEqualObjects(req.data, d, @"[DSPaymentProtocolRequest toData]");

    // test that the x509 certs are valid, but the payment request is expired (BUG: XXXX the cert is now expired!)
    XCTAssertFalse([req isValid], @"[DSPaymentProtocolRequest isValid]");
    XCTAssertEqualObjects(req.errorMessage,
        @"Untrusted certificate - One or more certificates have expired or are not valid yet.",
        @"[DSPaymentProtocolRequest isValid]");

    NSLog(@"commonName:%@", req.commonName);
    XCTAssertEqualObjects(req.commonName, @"coinbase.com", @"[DSPaymentProtocolRequest commonName]");


    d = @"08011209783530392b736861311aee210ae10a3082055d30820445a0030201020210131b73f7cc0dd0ef4fd9baa161dfd202300d06092"
         "a864886f70d01010b0500308190310b3009060355040613024742311b30190603550408131247726561746572204d616e636865737465"
         "723110300e0603550407130753616c666f7264311a3018060355040a1311434f4d4f444f204341204c696d69746564313630340603550"
         "403132d434f4d4f444f2052534120446f6d61696e2056616c69646174696f6e2053656375726520536572766572204341301e170d3134"
         "313030383030303030305a170d3136313030373233353935395a30573121301f060355040b1318446f6d61696e20436f6e74726f6c205"
         "6616c69646174656431143012060355040b130b506f73697469766553534c311c301a060355040313137061796d656e74732e6269746f"
         "6e69632e657530820122300d06092a864886f70d01010105000382010f003082010a0282010100c1dff3454587b55e6bf004b664f477c"
         "2b0c1b739f782babf2c591d674a9bf8311b26f9dd6b14bac7b18800cc76f406459210d883d13fff3fe58418ca684363db7e5bbd2aa534"
         "81cfce7ae83b87f306689c93c46371da3e9e7270a56e6d72d2b966b2ca18f219f2fb19bfda4258884ab6fda662bd130b1fce2f994f46c"
         "a85e230d9e122ead147f61649684b9077a25122846dc89ffe03d4bf36a2712b91e6b8c0b0b1182e3c46d89b4e34ab9e86e4f7e5b98435"
         "74d5b38ca7c8f6a72bbb3f7a93b33ed0191c4bc8d269de13eaeea9a3ff33bc454dd4e48e664346f3643e6c6dfc3328c8c10a1e712cd69"
         "5131e66641bb9a4a198ffc34c9477725c6b94173be3dd0203010001a38201e9308201e5301f0603551d2304183016801490af6a3a945a"
         "0bd890ea125673df43b43a28dae7301d0603551d0e04160414e23d0ca9028de4cf10359afe36c90bc63b78f4d9300e0603551d0f0101f"
         "f0404030205a0300c0603551d130101ff04023000301d0603551d250416301406082b0601050507030106082b06010505070302304f06"
         "03551d2004483046303a060b2b06010401b23101020207302b302906082b06010505070201161d68747470733a2f2f7365637572652e6"
         "36f6d6f646f2e636f6d2f4350533008060667810c01020130540603551d1f044d304b3049a047a0458643687474703a2f2f63726c2e63"
         "6f6d6f646f63612e636f6d2f434f4d4f444f525341446f6d61696e56616c69646174696f6e53656375726553657276657243412e63726"
         "c30818506082b0601050507010104793077304f06082b060105050730028643687474703a2f2f6372742e636f6d6f646f63612e636f6d"
         "2f434f4d4f444f525341446f6d61696e56616c69646174696f6e53656375726553657276657243412e637274302406082b06010505073"
         "0018618687474703a2f2f6f6373702e636f6d6f646f63612e636f6d30370603551d110430302e82137061796d656e74732e6269746f6e"
         "69632e657582177777772e7061796d656e74732e6269746f6e69632e6575300d06092a864886f70d01010b0500038201010077bbdd872"
         "7eb42b69bac73a7afa4e7254a8f2aa4899d0d3e411f25ac5ff6c36fe754c890ee1835a0c67af5019537220e8d6694808d83278fc77d80"
         "48e842117a1793d6dd467611330943d951a512b17975c60d9b4b32ca0f8f5423893f14b823bbb9acffad782512c1d45ab22cf6cb66168"
         "c6d201a435ddc74b5c47701449c23a3ad019c870258c275071ba8e46cb2b84e5259d7e81cd58eb42ffc249ac7d95d937fceb6e6ebc1ba"
         "d1778a4cb41e23c23d16fcef4331563df6f903753d834a1ddb17b1e6642edad1a8e884cc5e832cf1d791c62f68cd5bd135ea9012fa125"
         "95b660fc061fe078d896a08e8046d2b828f97b7b3aac875ebe524ebff0c55a45b250a8c0c30820608308203f0a00302010202102b2e6e"
         "ead975366c148a6edba37c8c07300d06092a864886f70d01010c0500308185310b3009060355040613024742311b30190603550408131"
         "247726561746572204d616e636865737465723110300e0603550407130753616c666f7264311a3018060355040a1311434f4d4f444f20"
         "4341204c696d69746564312b302906035504031322434f4d4f444f205253412043657274696669636174696f6e20417574686f7269747"
         "9301e170d3134303231323030303030305a170d3239303231313233353935395a308190310b3009060355040613024742311b30190603"
         "550408131247726561746572204d616e636865737465723110300e0603550407130753616c666f7264311a3018060355040a1311434f4"
         "d4f444f204341204c696d69746564313630340603550403132d434f4d4f444f2052534120446f6d61696e2056616c69646174696f6e20"
         "5365637572652053657276657220434130820122300d06092a864886f70d01010105000382010f003082010a02820101008ec20219e1a"
         "059a4eb38358d2cfd01d0d349c064c70b620545163aa8a0c00c027f1dccdbc4a16d7703a30f86f9e3069c3e0b818a9b491bad03befa4b"
         "db8c20edd5ce5e658e3e0daf4cc2b0b7455e522f34de482464b441ae0097f7be67de9ed07aa753803b7cadf596556f97470a7c858b229"
         "78db384e09657d0701860968fee2d07939da1bacad1cd7be9c42a9a2821914d6f924f25a5f27a35dd26dc46a5d0ac59358cff4e914350"
         "3f59931e6c5121ee5814abfe7550783e4cb01c8613fa6b98bce03b941e8552dc039324186ecb275145e670de2543a40de14aa5edb67ec"
         "8cd6dee2e1d27735ddc453080aae3b2410bafbd4487dab9e51b9d7faee58582a50203010001a382016530820161301f0603551d230418"
         "30168014bbaf7e023dfaa6f13c848eadee3898ecd93232d4301d0603551d0e0416041490af6a3a945a0bd890ea125673df43b43a28dae"
         "7300e0603551d0f0101ff04040302018630120603551d130101ff040830060101ff020100301d0603551d250416301406082b06010505"
         "07030106082b06010505070302301b0603551d200414301230060604551d20003008060667810c010201304c0603551d1f04453043304"
         "1a03fa03d863b687474703a2f2f63726c2e636f6d6f646f63612e636f6d2f434f4d4f444f52534143657274696669636174696f6e4175"
         "74686f726974792e63726c307106082b0601050507010104653063303b06082b06010505073002862f687474703a2f2f6372742e636f6"
         "d6f646f63612e636f6d2f434f4d4f444f525341416464547275737443412e637274302406082b060105050730018618687474703a2f2f"
         "6f6373702e636f6d6f646f63612e636f6d300d06092a864886f70d01010c050003820201004e2b764f921c623689ba77c12705f41cd64"
         "49da99a3eaad56666013eea49e6a235bcfaf6dd958e9935980e361875b1dddd50727caedc7788ce0ff79020caa3672e1f567f7be144ea"
         "4295c45d0d01504615f28189596c8add8cf112a18d3a428a98f84b347b273b08b46f243b729d6374583c1a6c3f4fc7119ac8a8f5b537e"
         "f1045c66cd9e05e9526b3ebada3b9ee7f0c9a66357332604ee5dd8a612c6e5211776896d318755115001b7488dde1c738044328e916fd"
         "d905d45d472760d6fb383b6c72a294f8421adfed6f068c45c20600aae4e8dcd9b5e17378ecf623dcd1dd6c8e1a8fa5ea547c96b7c3fe5"
         "58e8d495efc64bbcf3ebd96eb69cdbfe048f1628210e50c4657f233dad0c863edc61f9405964a1a91d1f7ebcf8f52ae0d08d93ea8a051"
         "e9c18774d5c9f774ab2e53fbbb7afb97e2f81f268fb3d2a0e0375b283b31e50e572d5ab8ad79ac5e20661aa5b9a6b539c1f59843ffeef"
         "9a7a7fdeeca243d8016c4178f8ac160a10cae5b4347914bd59a175ff9d487c1c28cb7e7e20f30193786ace0dc4203e694a89daefd0f24"
         "5194ce9208d1fc50f003407b8859ed0eddacd2778234dc069502d890f92dea37d51a60d06720d7d8420b45af8268dedd6624379029941"
         "9461925b880d7cbd486286a4470262362a99f866fbfba9070d256778578efea25a917ce50728c003aaae3db63349ff8067101e28220d4"
         "fe6fbdb10af80a308205743082045ca00302010202102766ee56eb49f38eabd770a2fc84de22300d06092a864886f70d01010c0500306"
         "f310b300906035504061302534531143012060355040a130b416464547275737420414231263024060355040b131d4164645472757374"
         "2045787465726e616c20545450204e6574776f726b312230200603550403131941646454727573742045787465726e616c20434120526"
         "f6f74301e170d3030303533303130343833385a170d3230303533303130343833385a308185310b3009060355040613024742311b3019"
         "0603550408131247726561746572204d616e636865737465723110300e0603550407130753616c666f7264311a3018060355040a13114"
         "34f4d4f444f204341204c696d69746564312b302906035504031322434f4d4f444f205253412043657274696669636174696f6e204175"
         "74686f7269747930820222300d06092a864886f70d01010105000382020f003082020a028202010091e85492d20a56b1ac0d24ddc5cf4"
         "46774992b37a37d23700071bc53dfc4fa2a128f4b7f1056bd9f7072b7617fc94b0f17a73de3b00461eeff1197c7f4863e0afa3e5cf993"
         "e6347ad9146be79cb385a0827a76af7190d7ecfd0dfa9c6cfadfb082f4147ef9bec4a62f4f7f997fb5fc674372bd0c00d689eb6b2cd3e"
         "d8f981c14ab7ee5e36efcd8a8e49224da436b62b855fdeac1bc6cb68bf30e8d9ae49b6c6999f878483045d5ade10d3c4560fc32965127"
         "bc67c3ca2eb66bea46c7c720a0b11f65de4808baa44ea9f283463784ebe8cc814843674e722a9b5cbd4c1b288a5c227bb4ab98d9eee05"
         "183c309464e6d3e99fa9517da7c3357413c8d51ed0bb65caf2c631adf57c83fbce95dc49baf4599e2a35a24b4baa9563dcf6faaff4958"
         "bef0a8fff4b8ade937fbbab8f40b3af9e843421e89d884cb13f1d9bbe18960b88c2856ac141d9c0ae771ebcf0edd3da996a148bd3cf7a"
         "fb50d224cc01181ec563bf6d3a2e25bb7b204225295809369e88e4c65f191032d707402ea8b671529695202bbd7df506a5546bfa0a328"
         "617f70d0c3a2aa2c21aa47ce289c064576bf821827b4d5aeb4cb50e66bf44c867130e9a6df1686e0d8ff40ddfbd042887fa3333a2e5c1"
         "e41118163ce18716b2beca68ab7315c3a6a47e0c37959d6201aaff26a98aa72bc574ad24b9dbb10fcb04c41e5ed1d3d5e289d9cccbfb3"
         "51daa747e584530203010001a381f43081f1301f0603551d23041830168014adbd987a34b426f7fac42654ef03bde024cb541a301d060"
         "3551d0e04160414bbaf7e023dfaa6f13c848eadee3898ecd93232d4300e0603551d0f0101ff040403020186300f0603551d130101ff04"
         "0530030101ff30110603551d20040a300830060604551d200030440603551d1f043d303b3039a037a0358633687474703a2f2f63726c2"
         "e7573657274727573742e636f6d2f416464547275737445787465726e616c4341526f6f742e63726c303506082b060105050701010429"
         "3027302506082b060105050730018619687474703a2f2f6f6373702e7573657274727573742e636f6d300d06092a864886f70d01010c0"
         "500038201010064bf83f15f9a85d0cdb8a129570de85af7d1e93ef276046ef15270bb1e3cff4d0d746acc818225d3c3a02a5d4cf5ba8b"
         "a16dc4540975c7e3270e5d847937401377f5b4ac1cd03bab1712d6ef34187e2be979d3ab57450caf28fad0dbe5509588bbdf8557697d9"
         "2d852ca7381bf1cf3e6b86e661105b31e942d7f91959259f14ccea391714c7c470c3b0b19f6a1b16c863e5caac42e82cbf90796ba484d"
         "90f294c8a973a2eb067b239ddea2f34d559f7a6145981868c75e406b23f5797aef8cb56b8bb76f46f47bf13d4b04d89380595ae041241"
         "db28f15605847dbef6e46fd15f5d95f9ab3dbd8b8e440b3cd9739ae85bb1d8ebcdc879bd1a6eff13b6f10386f22720a046d61696e121f"
         "08a8ef0f121976a914136a8e0aaff92594668980ad47287a7103503f5788ac209c85a0b9052a1b446f6e617469652061616e204269747"
         "3206f662046726565646f6d322668747470733a2f2f627061792e746f2f6d2f30396636366463623263303339386635386165362a8002"
         "b58932c12f8e7015c0797be9c644317dc15f03ce9a4c9c6430147c55cf5c9806895fc7582fd63466abee43eb17b3b0309697f2b79ef28"
         "911986a93cf4fef52d90446a4321efc17c50380b06b9088f427b384523c912070a87cf7f3a2f82dab57c9bd983b799b8a49dce5f797d5"
         "0418c3addca947098c7745f9a8da2bff50185a03b8852c5c37e94c73b56f456ac38999e1600f8ccba72d12994a0ca40edb9e6ef5c2c72"
         "77107aee87b589e1c6d4ba92f6cc9ad7489a3b6a2dccbc62178a7440f563b266aa185c50e72ca97d0abab243c72ce30b8a2ab82a2dd03"
         "e45460f549f41765ee6ebd4aadfaaa5d3ce1cea9bc0253b2187193797e27753259eda7a0367c".hexToData;

    req = [DSPaymentProtocolRequest requestWithData:d onChain:self.chain];

    XCTAssertEqualObjects(req.data, d, @"[DSPaymentProtocolRequest toData]");

    // test that the x509 certs are valid, but the payment request is expired
    XCTAssertFalse([req isValid], @"[DSPaymentProtocolRequest isValid]");
    //    XCTAssertEqualObjects(req.errorMessage, @"request expired", @"[DSPaymentProtocolRequest isValid]");

    NSLog(@"commonName:%@", req.commonName);
    XCTAssertEqualObjects(req.commonName, @"payments.bitonic.eu", @"[DSPaymentProtocolRequest commonName]");
}

@end
